import{_ as s,c as a,o as n,V as l}from"./chunks/framework.ad474ad6.js";const i=JSON.parse('{"title":"为什么DEX需要授权?","description":"为什么DEX需要授权?","frontmatter":{"title":"为什么DEX需要授权?","description":"为什么DEX需要授权?","date":"2023-02-16T00:00:00.000Z","tags":["区块链"]},"headers":[],"relativePath":"posts/为什么DEX需要授权.md"}'),p={name:"posts/为什么DEX需要授权.md"},o=l(`<h3 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h3><p>我们在第一次使用Uniswap这一类的DEX的时候，在swap之前，会需要进行approve的操作。这让人很疑惑，心里发问，我直接转账不就完了吗？授权啥？</p><p>今天，我们来研究下，为什么swap之前需要approve</p><h3 id="协议" tabindex="-1">协议 <a class="header-anchor" href="#协议" aria-label="Permalink to &quot;协议&quot;">​</a></h3><p>首先，我们以Ethereum为例，转账的都是ERC-20代币，那么我们就来直接看<a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noreferrer">ERC-20的协议标准</a></p><p>相关的方法事件有：</p><div class="language-solidity"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">balanceOf</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">_owner</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> :  //</span><span style="color:#82AAFF;">查询余额</span></span>
<span class="line"><span style="color:#82AAFF;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transfer</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> //</span><span style="color:#82AAFF;">转账</span></span>
<span class="line"><span style="color:#82AAFF;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transferFrom</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_from</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> // </span><span style="color:#82AAFF;">转账</span></span>
<span class="line"><span style="color:#82AAFF;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">approve</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_spender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> // </span><span style="color:#82AAFF;">授权</span></span>
<span class="line"><span style="color:#82AAFF;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">allowance</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_owner</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_spender</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  // </span><span style="color:#82AAFF;">查询授权额度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Transfer</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">indexed</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_from</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">indexed</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> // </span><span style="color:#82AAFF;">Transfer事件</span></span>
<span class="line"><span style="color:#82AAFF;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Approval</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">indexed</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_owner</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">indexed</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_spender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> //</span><span style="color:#82AAFF;">Approval事件</span></span></code></pre></div><h3 id="代码" tabindex="-1">代码 <a class="header-anchor" href="#代码" aria-label="Permalink to &quot;代码&quot;">​</a></h3><p>然后，我门直接上代码，看 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/9b3710465583284b8c4c5d2245749246bb2e0094/contracts/token/ERC20/ERC20.sol" target="_blank" rel="noreferrer">openzeppelin的实现</a></p><p>首先是全局变量和allowance和balanceOf方法</p><div class="language-solidity"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 首先是两个全局变量map</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mapping</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">uint256</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 存储地址address的余额</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mapping</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">mapping</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">uint256</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> _allowed</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">// 存储地址address1对address2的授权额度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// allowance方法</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">allowance</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">owner</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">spender</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">view</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">returns</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">uint256</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> _allowed</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">owner</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">spender</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// 返回_allowed 这个map中存储的：ownder对spender的授权额度</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// balanceOf方法</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">balanceOf</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">owner</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">view</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">returns</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">uint256</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">owner</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//返回_balances 这个map中存储的：ownder的余额</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><p>balanceOf方法，就是接收一个账户地址，返回该地址中这个ERC-20 token的余额</p><p>allowance方法，有两个参数，owner和spender，返回owner对spender的针对这个ERC-20 token的授权额度</p><p>然后是涉及到转账的方法，分别是transfer和transferFrom</p><div class="language-solidity"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// transfer方法</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transfer</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">returns</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bool</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">]);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// transfer的数量value要 &lt;= msg.sender的余额</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">to </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">address</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">// 接收方to地址不能为空</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// msg.sender的余额扣除transfer的数量value</span></span>
<span class="line"><span style="color:#A6ACCD;">    _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">to</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">to</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 接收方to地址的余额增加transfer的数量value</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">emit</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Transfer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 触发Transfer事件</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// transferFrom方法</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">transferFrom</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">from</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">to</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">value</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">returns</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bool</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">]);</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// transfer的数量value要 &lt;= 发送方from的余额</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> _allowed</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">]);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// transfer的数量value要 &lt;= 发送方from对msg.sender的授权额度</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">to </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">address</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//接收方to地址不为空</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//发送方from的余额扣除transfer的数量value</span></span>
<span class="line"><span style="color:#A6ACCD;">    _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">to</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _balances</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">to</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//接收方to的余额增加transfer的数量value</span></span>
<span class="line"><span style="color:#A6ACCD;">    _allowed</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _allowed</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">sub</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 发送方from对msg.sender的授权额度扣除transfer的数量value</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">emit</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Transfer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 触发Transfer事件</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><p>transfer方法，就是向to地址转账value个token，前提是发送方的余额要大于转账个数value</p><p>transferFrom方法，就是从from地址向to地址转账value个token，前提是发送方from的余额要大于转账个数value，同时转账的个数value要小于发送方from对msg.sender的授权额度。</p><p>大家可能会有疑问，msg.sender不就是from吗？其实不是，钱是从from这里出去到to这里的，但是发送这个动作并不是from做出的，而是一个第三方中间人(通常是合约)来做的。可以这么理解，from事先给了msg.sender自己金库的钥匙，允许msg.sender可以去from的金库里取钱，transferFrom这个动作其实就是msg.sender从from的金库里取钱发送给了to。</p><p>from把自己的金库钥匙给msg.sender这个动作，就是授权</p><div class="language-solidity"><button title="Copy Code" class="copy"></button><span class="lang">solidity</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">approve</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">address</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">spender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">uint256</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">returns</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">bool</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">//接受两个参数，spender（被授权者）、value(授权额度)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">require</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">spender </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">address</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">// 被授权者的地址不为空</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    _allowed</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">][</span><span style="color:#A6ACCD;">spender</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">//msg.sender对spender授权value额度</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">emit</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Approval</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">msg.sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> spender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//触发Approval事件</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><p>上面的msg.sender就是当前调用ERC-20合约方法的人，这个人可以是一个普通账户，也可以是一个合约地址。</p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>一般来说，transfer方法是给普通账户用的。假设当a要向一个目标地址b转账某个ERC-20代币的时候，只需要调用这个ERC-20代币的transfer方法即可，此时msg.sender，也就是方法的调用者，就是这个普通账户a。</p><p>与之对应的,transferFrom方法一般是给合约用的。首先a授权给合约b转走token的权利，a授权b的时候，msg.sender是方法approve的调用者，也就是a。</p><p>然后合约b会调用transferFrom给c转账，这个时候msg.sender就是transferFrom的调用者，也就是合约b。</p><p>授权和转账这两步，都是需要收取gas fee的</p><p>为什么合约需要这么做呢？一般情况下，a调用transfer方法给b转账1个usdt，然后就结束了。</p><p>但是如果在DEX的场景下，a想要把1个usdt换成1个usdc。在这种情况下，a在向swap合约b转账1个usdt之后，<strong>b并不会得到任何的通知</strong>（因为<strong>ERC-20标准并没有规定一笔转账会通知到任何人</strong>），所以b并不会及时地给a转账1个usdc。</p><p>这个时候就需要transferFrom登场了，a先授权给合约b转走自己usdt的权利。然后a再去调用合约b的转账方法，合约b的转账方法会调用usdt的transferFrom方法直接从a那里拿到1个usdt，只要transferFrom方法成功，合约b就知道自己一定从a那里收到了1个usdt，所以合约b就可以给a转账1个usdc</p><h3 id="前端实现" tabindex="-1">前端实现 <a class="header-anchor" href="#前端实现" aria-label="Permalink to &quot;前端实现&quot;">​</a></h3><p>合约逻辑清楚了，其实前端的实现就很简单了,这里贴一些伪代码吧</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">首先声明一些变量</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 连接钱包地址 from</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 转账到的地址 to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 调用的swap合约 SWAP</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 转账的token USDT,它的合约地址 U</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 转账USDT的数量 amount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 调用U的合约方法allowance，判断allowance的返回值是否为0；如果不为0则直接调用SWAP合约的swap方法转账；如果allowance为0，则调用U的approve方法给SWAP合约授权,再调用SWAP合约的转账方法</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> allowed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">allowance</span><span style="color:#A6ACCD;">(from，SWAP)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;">(allowed</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> amount)</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">//这里一般是写allowed === 0，因为一般授权的都是最大数量，即时这个数量会随着每次transfer而减少，但是也几乎不可能出现allowed&lt;amount的情况</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">approve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">SWAP</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">最大数量</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">transfer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">from</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">to</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">amount</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 当然，SWAP合约的转账方法，本质上还是调用U的transferFrom方法，并在成功后会让to给from转账,其实是两笔转账(如果有流动性池，那可能是多笔)</span></span></code></pre></div><h4 id="引申问题" tabindex="-1">引申问题 <a class="header-anchor" href="#引申问题" aria-label="Permalink to &quot;引申问题&quot;">​</a></h4><ol><li><p>既然我们可以给一个合约授权，让他可以有转走我们的token的权利。那么我们可以取消授权吗？</p><p>答案是可以，我们只需要再次调用approve方法，把approve的数量设为0即可。一些插件钱包已经实现了这个功能。</p></li><li><p>ETH虽然是ethereum的原生代币，但是ETH并不是ERC-20代币，那么我们该怎么在ethereum上转账ETH呢？</p><p>答案是直接转即可，不需要授权。</p></li><li><p>假如想要实现像DEX这样的使用场景，那么只有两种办法，一种就是用WETH(ERC-20)，另一种就是合约做兼容，专门处理ETH的SWAP，普遍来说就是再写一个合约方法，SWAP、SWAPETH。</p></li></ol><h3 id="references" tabindex="-1">references <a class="header-anchor" href="#references" aria-label="Permalink to &quot;references&quot;">​</a></h3><p><a href="https://ethereum.stackexchange.com/questions/98892/what-is-the-difference-between-transfer-and-trasnferfrom-and-when-should-i-u" target="_blank" rel="noreferrer">what-is-the-difference-between-transfer-and-trasnferfrom</a></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/9b3710465583284b8c4c5d2245749246bb2e0094/contracts/token/ERC20/ERC20.sol" target="_blank" rel="noreferrer">ERC-20 implementation</a></p><p><a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noreferrer">ERC-20的协议标准</a></p><p><a href="https://ethereum.stackexchange.com/questions/28233/how-to-do-approve-and-transferfrom-for-ether" target="_blank" rel="noreferrer">how-to-do-approve-and-transferfrom-for-ether</a></p><p><a href="https://docs.openzeppelin.com/contracts/4.x/erc20" target="_blank" rel="noreferrer">实现自己的ERC-20</a></p>`,40),e=[o];function t(r,c,y,A,D,F){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{i as __pageData,d as default};
