---
title: è·ç¦»å‘¨æœ«è¿˜æœ‰å¤šä¹…ä¼‘æ¯æç¤º 
description: æç¤ºè·ç¦»å‘¨æœ«è¿˜æœ‰å¤šä¹…ä¼‘æ¯
date: 2023-07-28
tags:
  - è„šæœ¬çŒ«
---

# è·ç¦»å‘¨æœ«è¿˜æœ‰å¤šä¹…ä¼‘æ¯æç¤º

```javascript
// ==UserScript==
// @name         è·ç¦»å‘¨æœ«è¿˜æœ‰å¤šä¹…ä¼‘æ¯æç¤º
// @namespace    https://bbs.tampermonkey.net.cn/
// @version      0.0.1
// @description  æç¤ºè·ç¦»å‘¨æœ«è¿˜æœ‰å¤šä¹…ä¼‘æ¯
// @author       yinyuejun
// @grant        GM_notification
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @crontab      0 9,18 * * *
// @debug
// ==/UserScript==
function getAvatarAndImage(id) {
    const baseUrl = "https://gitee.com/hewang1an/StarRail-plugin/raw/main/resources/panel/resources";
    return {
        avatarUrl: baseUrl + `/avatar/${id}.png`,
        charImageUrl: baseUrl + `/char_image/${id}.png`,
    };
}

async function fetchCharacterData() {
    try {
        const response = await fetch("https://songzhanpeng.github.io/character.json");
        const data = await response.json();
        return data;
    } catch (error) {
        console.error("Error fetching character data:", error);
        return null;
    }
}

async function getRandomRole(id) {
    const cachedData = GM_getValue("characterData");
    if (cachedData) {
        const roleList = Object.entries(cachedData);
        const filteredRoleList = id ? roleList.filter(role => role[1].id == id) : roleList;

        if (filteredRoleList.length === 0) {
            // If there are no roles matching the provided id, fallback to a random role
            const randomIndex = Math.floor(Math.random() * roleList.length);
            const roleInfo = roleList[randomIndex];
            const { avatarUrl, charImageUrl } = getAvatarAndImage(roleInfo[0]);
            return {
                id: roleInfo[1].id,
                name: roleInfo[1].name,
                avatar: avatarUrl,
                charImage: charImageUrl,
            };
        }

        const randomIndex = Math.floor(Math.random() * filteredRoleList.length);
        const roleInfo = filteredRoleList[randomIndex];
        const { avatarUrl, charImageUrl } = getAvatarAndImage(roleInfo[0]);
        return {
            id: roleInfo[1].id,
            name: roleInfo[1].name,
            avatar: avatarUrl,
            charImage: charImageUrl,
        };
    } else {
        const characterData = await fetchCharacterData();
        if (characterData) {
            GM_setValue("characterData", characterData);
            return getRandomRole();
        }
        return null;
    }
}

function calculateRemainingTime() {
    const currentDate = new Date();
    const currentDay = currentDate.getDay(); // å½“å‰æ˜ŸæœŸå‡ ï¼ˆ0-6ï¼Œ0ä»£è¡¨æ˜ŸæœŸæ—¥ï¼‰
    const currentHour = currentDate.getHours(); // å½“å‰å°æ—¶ï¼ˆ0-23ï¼‰

    // è®¡ç®—è·ç¦»å‘¨äº”ä¸‹ç­è¿˜æœ‰å¤šå°‘æ—¶é—´
    let remainingDays = 0;
    let remainingHours = 0;
    let remainingMinutes = 0;
    let remainingSeconds = 0;

    if (currentDay === 5 && currentHour >= 18) {
        // å¦‚æœå·²ç»æ˜¯å‘¨äº”ä¸‹ç­æ—¶é—´æˆ–æ›´æ™šï¼Œåˆ™è®¡ç®—è·ç¦»ä¸‹ä¸€ä¸ªå‘¨äº”è¿˜æœ‰å¤šå°‘å¤©
        remainingDays = 7 - currentDay;
    } else {
        // å¦åˆ™ï¼Œè®¡ç®—è·ç¦»å½“å‰å‘¨äº”ä¸‹ç­è¿˜æœ‰å¤šå°‘æ—¶é—´
        remainingDays = 5 - currentDay;
        remainingHours = currentHour < 18 ? 18 - currentHour : 0;
        remainingMinutes = 60 - currentDate.getMinutes();
        remainingSeconds = 60 - currentDate.getSeconds();
    }

    return {
        days: remainingDays,
        hours: remainingMinutes ? remainingHours - 1 : remainingHours,
        minutes: remainingMinutes,
        seconds: remainingSeconds,
    };
}

function formatTimeValue(value) {
    return value.toString().padStart(2, '0');
}

function formatRemainingTime(remainingTime) {
    const daysStr = remainingTime.days > 0 ? `${remainingTime.days} å¤© ` : '';
    const hoursStr = remainingTime.hours > 0 ? `${formatTimeValue(remainingTime.hours)} å°æ—¶ ` : '';
    const minutesStr = remainingTime.minutes > 0 ? `${formatTimeValue(remainingTime.minutes)} åˆ†é’Ÿ ` : '';
    const secondsStr = remainingTime.seconds > 0 ? `${formatTimeValue(remainingTime.seconds)} ç§’` : '';

    return daysStr + hoursStr + minutesStr + secondsStr || 'æ¬¢è¿å‘¨æœ«';
}

function getRandomEncouragingMessage() {
  // å¹³æ—¥é¼“åŠ±æ–‡æ¡ˆ
  const encouragingMessages = [
        'å‘¨æœ«å°±å¿«åˆ°äº†ï¼ŒåŠ æ²¹å·¥ä½œå“¦ï¼',
        'ä¸è¦æ”¾å¼ƒï¼ŒåšæŒåˆ°å‘¨æœ«å°±å¯ä»¥è½»æ¾å•¦ï¼',
        'å†åŠªåŠ›ä¸€ç‚¹ï¼Œç¦»å‘¨æœ«è¶Šæ¥è¶Šè¿‘äº†ï¼',
        'å‘¨æœ«çš„å–œæ‚¦å³å°†åˆ°æ¥ï¼ŒåŠ æ²¹ï¼',
        'åŠ æ²¹åŠ æ²¹ï¼Œå‘¨æœ«ç­‰ç€ä½ ï¼',
        'å‘¨æœ«é©¬ä¸Šå°±åˆ°äº†ï¼Œä¸€åˆ‡éƒ½ä¼šå˜å¾—æ›´å¥½ï¼',
        'ç›¸ä¿¡è‡ªå·±ï¼Œä½ èƒ½è¡Œï¼å‘¨æœ«ä¼šæ›´ç¾å¥½ï¼',
        'å¹²å¾—æ¼‚äº®ï¼å‘¨æœ«ä¼‘æ¯çš„æ—¶å…‰é©¬ä¸Šå°±è¦åˆ°æ¥ï¼',
        'æ¯ä¸€ä»½ä»˜å‡ºï¼Œéƒ½ä¼šæœ‰å›æŠ¥ã€‚å‘¨æœ«åœ¨ç­‰ç€ä½ ï¼',
        'ç»§ç»­åŠªåŠ›ï¼Œä½ ç¦»å‘¨æœ«è¶Šæ¥è¶Šè¿‘äº†ï¼',
        'åšæŒä¸‹å»ï¼Œå¿«ä¹çš„å‘¨æœ«é©¬ä¸Šåˆ°æ¥ï¼',
        'åŠ æ²¹ï¼æ¯ä¸€å¤©éƒ½ç¦»å‘¨æœ«æ›´è¿‘äº†ä¸€æ­¥ï¼',
        'è·ç¦»å‘¨æœ«åªæœ‰ä¸€æ­¥ä¹‹é¥ï¼Œç»§ç»­å‰è¿›å§ï¼',
        'åˆ«å¿˜è®°å¾®ç¬‘ï¼Œå‘¨æœ«ä¼šå› æ­¤æ›´åŠ ç¾å¥½ï¼',
        'æ¯ä¸€ä»½åŠªåŠ›éƒ½å€¼å¾—ï¼Œå‘¨æœ«ä¼šç»™ä½ å¥–åŠ±ï¼',
        'ä¸€å‘¨çš„åŠªåŠ›å³å°†ç»“å‡ºç”œèœœçš„å‘¨æœ«æœå®ï¼',
        'å‘ç€å‘¨æœ«çš„æ–¹å‘ï¼Œåšå®šå‰è¡Œï¼',
        'æ”¾é£å¿ƒæƒ…ï¼Œå¿«ä¹çš„å‘¨æœ«å³å°†æ¥ä¸´ï¼',
        'æ„Ÿè°¢ä½ çš„ä»˜å‡ºï¼Œå‘¨æœ«å°†æ˜¯ä½ çš„å¥–åŠ±ï¼',
        'ä¸è®ºå‰æ–¹æœ‰å¤šå°‘å›°éš¾ï¼Œå‘¨æœ«éƒ½å€¼å¾—æœŸå¾…ï¼',
    ];

  // å‘¨æœ«é¼“åŠ±æ–‡æ¡ˆï¼ˆå‘¨äº”ä¸‹ç­ï¼‰
  const weekendMessages = [
    'ğŸ‰ å‘¨æœ«åˆ°å•¦ï¼å¥½å¥½äº«å—ç¾å¥½æ—¶å…‰å§ï¼ ğŸ‰',
    'ğŸŒŸ å‘¨æœ«æ¬¢è¿ä½ çš„åˆ°æ¥ï¼å°½æƒ…æ”¾æ¾å§ï¼ ğŸŒŸ',
    'ğŸ» æ­å–œï¼Œå‘¨æœ«æ¥æŠ¥åˆ°ï¼å°½æƒ…åº†ç¥å§ï¼ ğŸ»',
    'ğŸš€ å‘¨æœ«å·²å¯åŠ¨ï¼å¼€å¯ä½ çš„æ„‰å¿«æ—¶å…‰ï¼ ğŸš€',
    'ğŸŠ å‘¨æœ«åˆ°æ¥ï¼Œå¿«ä¹åŠ å€ï¼äº«å—å§ï¼ ğŸŠ',
  ];

  const currentDate = new Date();
  const currentDay = currentDate.getDay();
  const currentHour = currentDate.getHours();

  // æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨äº”å¹¶ä¸”æ—¶é—´æ™šäº18ç‚¹
  const isFridayAfterWork = currentDay === 5 && currentHour >= 18;

  if (isFridayAfterWork) {
    const randomIndex = Math.floor(Math.random() * weekendMessages.length);
    return weekendMessages[randomIndex];
  } else {
    const randomIndex = Math.floor(Math.random() * encouragingMessages.length);
    return encouragingMessages[randomIndex];
  }
}

return new Promise(async (resolve, reject) => {
    const currentDate = new Date();
    const currentHour = currentDate.getHours();
    if ([1, 2, 3, 4, 5].includes(new Date().getDay())) {
        const remainingTime = calculateRemainingTime();
        console.log('remainingTime', remainingTime);

        const remainingTimeStr = formatRemainingTime(remainingTime);
        const encouragingMessage = getRandomEncouragingMessage();

        const role = await getRandomRole();
        const text = `å–‚ï¼æœ‹å‹ï¼\nè·ç¦»å‘¨æœ«ä¸‹ç­è¿˜æœ‰\n${remainingTimeStr}\n${encouragingMessage}`;

        GM_notification({
            title: role.name,
            text: text,
            image: role.avatar,
            ondone: (user) => {
                console.log('done user:', user);
                resolve();
            },
            onclick: () => {
                console.log('click');
                resolve();
            },
        });
    } else {
        resolve();
    }
});




```
